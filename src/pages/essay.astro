---
import Comment from "@components/comment/index.astro";
import { Icon } from "astro-icon/components";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import { fetchEch0Posts } from "../utils/ech0-api";
import { profileConfig } from "../config";

// 从Ech0 API获取动态数据（服务器端）
let essays = await fetchEch0Posts("https://say.allen2030.com");

// 如果服务器端获取失败（只有一条备用数据），标记需要客户端获取
const needsClientFetch = essays.length === 1 && essays[0].tags.includes("系统");

// 处理每条说说数据，提取#标签
const processedEssays = essays.map(essay => {
    // 从内容中提取#标签
    const hashTags = essay.content.match(/#[^\s#]+/g) || [];
    const cleanHashTags = hashTags.map((tag: string) => tag.replace('#', ''));
    
    // 合并标签并去重
    const allTags = [...cleanHashTags, ...(essay.tags || [])];
    const uniqueTags = [...new Set(allTags)].slice(0, 3);
    
    // 过滤掉内容中的#标签
    const cleanContent = essay.content.replace(/#[^\s#]+/g, '').trim();
    
    return {
        ...essay,
        cleanContent,
        displayTags: uniqueTags,
        hasTags: uniqueTags.length > 0
    };
});

// 为评论区创建一个模拟的post对象
const mockPost = {
	slug: "essay",
	data: {
		title: "瞬间",
	},
};
---

<MainGridLayout title="瞬间" description="记录生活中的美好瞬间">
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
        <div class="card-base z-10 px-6 md:px-9 py-6 relative w-full">
            <h1 class="text-4xl font-bold mb-6 text-neutral-900 dark:text-white">说说</h1>
            
            <div id="essays-container" class="columns-1 md:columns-2 lg:columns-3 gap-4 space-y-4" data-needs-fetch={needsClientFetch ? "true" : "false"}>
                {processedEssays.map((essay) => (
                    <div class="essay-item break-inside-avoid bg-[var(--card-bg)] rounded-xl p-4 shadow-sm border border-[var(--line-divider)] transition-all hover:shadow-md">
                        <!-- 顶部：头像、用户名、时间 -->
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 rounded-full overflow-hidden bg-[var(--btn-card-bg-hover)] flex-shrink-0">
                                <img 
                                    src={profileConfig.avatar} 
                                    alt={profileConfig.name}
                                    class="w-full h-full object-cover"
                                />
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-1">
                                    <span class="font-medium text-90 text-sm truncate">{profileConfig.name}</span>
                                    <Icon name="material-symbols:verified-rounded" class="w-4 h-4 text-blue-500 flex-shrink-0" />
                                </div>
                                <div class="text-xs text-50">{essay.time}</div>
                            </div>
                        </div>
                        
                        <!-- 内容（已过滤#标签） -->
                        <div class="essay-content text-90 text-sm leading-relaxed mb-3 whitespace-pre-wrap">
                            {essay.cleanContent}
                        </div>
                        
                        <!-- 图片 -->
                        {essay.images && essay.images.length > 0 && (
                            <div class="essay-images mb-3">
                                <div class:list={[
                                    "grid gap-2",
                                    essay.images.length === 1 ? "grid-cols-1" : 
                                    essay.images.length === 2 ? "grid-cols-2" :
                                    "grid-cols-2"
                                ]}>
                                    {essay.images.slice(0, 4).map((image, index) => (
                                        <div class="rounded-lg overflow-hidden bg-[var(--btn-card-bg-hover)] aspect-video">
                                            <img 
                                                src={image} 
                                                alt={`瞬间图片 ${index + 1}`}
                                                class="w-full h-full object-cover hover:scale-105 transition-transform duration-300 cursor-pointer"
                                                loading="lazy"
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        <!-- 底部标签 -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-1 flex-wrap">
                                {essay.hasTags ? (
                                    essay.displayTags.map((tag: string) => (
                                        <span class="px-2 py-1 bg-[var(--btn-card-bg-hover)] rounded-md text-xs text-75">
                                            {tag}
                                        </span>
                                    ))
                                ) : (
                                    <span class="px-2 py-1 bg-[var(--btn-card-bg-hover)] rounded-md text-xs text-50">
                                        无标签
                                    </span>
                                )}
                            </div>
                            
                            <!-- 评论按钮 -->
                            <button 
                                class="flex items-center gap-1 text-xs text-75 hover:text-primary transition-colors p-1 rounded hover:bg-[var(--btn-card-bg-hover)]"
                                data-content={`${essay.content}`}
                                onclick="window.commentOnPost(this)"
                            >
                                <Icon name="material-symbols:chat-bubble-outline-rounded" class="w-4 h-4" />
                            </button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    </div>

    <!-- 评论区 -->
    <div id="comments-section" class="twikoo-container mt-8">
        <Comment path="/essay/" />
    </div>
</MainGridLayout>


<style>
    .essay-item {
        animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .essay-content {
        word-wrap: break-word;
    }
</style>

<script>
    // 扩展Window接口
    declare global {
        interface Window {
            commentOnPost: (button: HTMLButtonElement) => void;
        }
    }

    // 全局评论函数
    window.commentOnPost = function(button: HTMLButtonElement) {
        const content = button.dataset.content;
        console.log('commentOnPost called with content:', content);
        
        // 滚动到评论区
        const commentsSection = document.getElementById('comments-section');
        if (commentsSection) {
            console.log('Found comments section, scrolling...');
            commentsSection.scrollIntoView({ behavior: 'smooth' });
        } else {
            console.log('Comments section not found, scrolling to bottom...');
            window.scrollTo({ 
                top: document.body.scrollHeight, 
                behavior: 'smooth' 
            });
        }
        
        // 增加延迟时间，确保滚动完成且Twikoo完全加载
        setTimeout(() => {
            console.log('Trying to find textarea...');
            // 尝试找到Twikoo输入框
            const textarea = document.querySelector('.el-textarea__inner') as HTMLTextAreaElement | null || 
                           document.querySelector('#twikoo textarea') as HTMLTextAreaElement | null || 
                           document.querySelector('textarea') as HTMLTextAreaElement | null;
            
            if (textarea && content) {
                console.log('Found textarea:', textarea);
                // 填充引用内容
                textarea.value = `> ${content}\n\n`;
                // 聚焦输入框
                textarea.focus();
                // 触发输入事件
                textarea.dispatchEvent(new Event('input', { bubbles: true }));
                console.log('Content filled into textarea');
            } else {
                console.log('Textarea not found, trying again...');
                // 再次尝试
                setTimeout(() => {
                    const retryTextarea = document.querySelector('.el-textarea__inner') as HTMLTextAreaElement | null || 
                                         document.querySelector('textarea') as HTMLTextAreaElement | null;
                    if (retryTextarea && content) {
                        console.log('Found textarea on retry:', retryTextarea);
                        retryTextarea.value = `> ${content}\n\n`;
                        retryTextarea.focus();
                        retryTextarea.dispatchEvent(new Event('input', { bubbles: true }));
                        console.log('Content filled into textarea on retry');
                    } else {
                        console.log('Textarea still not found');
                    }
                }, 500);
            }
        }, 800);
    };

    // 客户端获取Ech0数据（作为服务器端获取失败的备用方案）
    async function fetchEch0PostsClient() {
        const container = document.getElementById('essays-container');
        if (!container || container.dataset.needsFetch !== 'true') {
            return; // 不需要客户端获取
        }

        try {
            console.log('Client-side fetching Ech0 posts...');
            const response = await fetch('https://say.allen2030.com/rss');
            
            if (!response.ok) {
                throw new Error(`Failed to fetch: ${response.status}`);
            }
            
            const xmlText = await response.text();
            console.log('Client-side RSS response length:', xmlText.length);
            
            // 解析RSS数据
            const entries = parseRSS(xmlText);
            console.log('Client-side parsed entries:', entries.length);
            
            if (entries.length > 0) {
                // 重新渲染说说列表
                renderEssays(entries);
            }
        } catch (error) {
            console.error('Client-side fetch error:', error);
            // 保持备用数据显示
        }
    }

    // 客户端RSS解析
    function parseRSS(xmlText: string) {
        const entryRegex = /<entry>([\s\S]*?)<\/entry>/g;
        const entries: any[] = [];
        let match: RegExpExecArray | null = null;
        let index = 0;
        
        while (true) {
            match = entryRegex.exec(xmlText);
            if (match === null) break;
            const entryText = match[1];
            index++;
            
            const updatedMatch = entryText.match(/<updated>([\s\S]*?)<\/updated>/);
            const updated = updatedMatch ? updatedMatch[1] : '';
            
            const summaryMatch = entryText.match(/<summary[^>]*>([\s\S]*?)<\/summary>/i);
            const summary = summaryMatch ? summaryMatch[1] : '';
            
            // 解码HTML实体
            let decodedSummary = summary
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&amp;/g, '&')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'");
            
            // 提取图片
            const images: string[] = [];
            const imgRegex = /<img[^>]+src="([^"]+)"/g;
            let imgMatch: RegExpExecArray | null = null;
            while (true) {
                imgMatch = imgRegex.exec(decodedSummary);
                if (imgMatch === null) break;
                images.push(imgMatch[1]);
            }
            
            // 提取纯文本内容
            const textContent = decodedSummary
                .replace(/<[^>]*>/g, '')
                .trim();
            
            // 提取标签
            const tags: string[] = [];
            const categoryRegex = /<category[^>]*term="([^"]+)"/g;
            let categoryMatch: RegExpExecArray | null = null;
            while (true) {
                categoryMatch = categoryRegex.exec(entryText);
                if (categoryMatch === null) break;
                tags.push(categoryMatch[1]);
            }
            
            // 格式化时间
            const date = new Date(updated);
            const timeStr = date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            entries.push({
                content: textContent || '[图片]',
                time: timeStr,
                images: images,
                tags: tags
            });
        }
        
        return entries;
    }

    // 渲染说说列表
    function renderEssays(entries: any[]) {
        const container = document.getElementById('essays-container');
        if (!container) return;
        
        // 获取头像和用户名
        const avatarImg = document.querySelector('.essay-item img') as HTMLImageElement | null;
        const userNameEl = document.querySelector('.essay-item .font-medium') as HTMLElement | null;
        const avatar = avatarImg ? avatarImg.src : '/favicon/favicon-light-128.png';
        const userName = userNameEl ? userNameEl.textContent : 'Allen';
        
        const html = entries.map((entry, index) => {
            // 从内容中提取#标签
            const hashTags = entry.content.match(/#[^\s#]+/g) || [];
            const cleanHashTags = hashTags.map((tag: string) => tag.replace('#', ''));
            const allTags = [...cleanHashTags, ...(entry.tags || [])];
            const uniqueTags = [...new Set(allTags)].slice(0, 3);
            const hasTags = uniqueTags.length > 0;
            
            // 过滤掉内容中的#标签
            const cleanContent = entry.content.replace(/#[^\s#]+/g, '').trim();
            
            const imagesHtml = entry.images && entry.images.length > 0 ? `
                <div class="essay-images mb-3">
                    <div class="grid gap-2 ${entry.images.length === 1 ? 'grid-cols-1' : 'grid-cols-2'}">
                        ${entry.images.slice(0, 4).map((image: string, idx: number) => `
                            <div class="rounded-lg overflow-hidden bg-[var(--btn-card-bg-hover)] aspect-video">
                                <img 
                                    src="${image}" 
                                    alt="瞬间图片 ${idx + 1}"
                                    class="w-full h-full object-cover hover:scale-105 transition-transform duration-300 cursor-pointer"
                                    loading="lazy"
                                />
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';
            
            const tagsHtml = hasTags 
                ? uniqueTags.map((tag: string) => `<span class="px-2 py-1 bg-[var(--btn-card-bg-hover)] rounded-md text-xs text-75">${tag}</span>`).join('')
                : `<span class="px-2 py-1 bg-[var(--btn-card-bg-hover)] rounded-md text-xs text-50">无标签</span>`;
            
            return `
                <div class="essay-item break-inside-avoid bg-[var(--card-bg)] rounded-xl p-4 shadow-sm border border-[var(--line-divider)] transition-all hover:shadow-md" style="animation-delay: ${index * 0.1}s">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-full overflow-hidden bg-[var(--btn-card-bg-hover)] flex-shrink-0">
                            <img 
                                src="${avatar}" 
                                alt="${userName}"
                                class="w-full h-full object-cover"
                            />
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1">
                                <span class="font-medium text-90 text-sm truncate">${userName}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-500 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                </svg>
                            </div>
                            <div class="text-xs text-50">${entry.time}</div>
                        </div>
                    </div>
                    
                    <div class="essay-content text-90 text-sm leading-relaxed mb-3 whitespace-pre-wrap">
                        ${cleanContent}
                    </div>
                    
                    ${imagesHtml}
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1 flex-wrap">
                            ${tagsHtml}
                        </div>
                        
                        <button 
                            class="flex items-center gap-1 text-xs text-75 hover:text-primary transition-colors p-1 rounded hover:bg-[var(--btn-card-bg-hover)]"
                            data-content="${entry.content.replace(/"/g, '&quot;')}"
                            onclick="window.commentOnPost(this)"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    }

    // 立即执行获取（不等待DOMContentLoaded）
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            fetchEch0PostsClient();
        });
    } else {
        fetchEch0PostsClient();
    }
    
    // 同时立即尝试获取，确保1秒内显示
    setTimeout(fetchEch0PostsClient, 100);
</script>
