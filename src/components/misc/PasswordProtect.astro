---
interface Props {
  postSlug: string;
  correctPassword: string;
}

const { postSlug, correctPassword } = Astro.props;
---

<div class="password-protect-wrapper" data-post-slug={postSlug} data-correct-password={correctPassword}>
  <div class="password-protect-container min-h-[60vh] flex items-center justify-center p-4">
    <div class="password-protect-card bg-[var(--card-bg)] rounded-[var(--radius-large)] shadow-lg p-8 max-w-md w-full border border-[var(--card-border)]">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-[var(--primary)]/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-[var(--primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-90">文章已加密</h2>
        <p class="text-75 mt-2">请输入密码以查看文章内容</p>
      </div>
      
      <form class="password-form space-y-4">
        <div>
          <label class="block text-sm font-medium text-75 mb-2">访问密码</label>
          <input 
            type="password" 
            class="password-input w-full px-4 py-3 border border-[var(--input-border)] rounded-lg bg-[var(--input-bg)] text-[var(--text-main)] placeholder-[var(--text-muted)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent transition"
            placeholder="请输入密码"
            autocomplete="off"
          />
        </div>
        <button 
          type="submit" 
          class="password-submit w-full bg-[var(--primary)] hover:bg-[var(--primary)]/90 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
          </svg>
          验证密码
        </button>
      </form>
      
      <div class="password-error mt-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-600 dark:text-red-400 text-sm hidden flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span class="password-error-text"></span>
      </div>
    </div>
  </div>
</div>

<script>
  // 等待 DOM 加载完成
  function initPasswordProtect() {
    const wrapper = document.querySelector('.password-protect-wrapper');
    if (!wrapper) return;
    
    const postSlug = wrapper.getAttribute('data-post-slug');
    const correctPassword = wrapper.getAttribute('data-correct-password');
    const form = wrapper.querySelector('.password-form');
    const input = wrapper.querySelector('.password-input');
    const submitBtn = wrapper.querySelector('.password-submit');
    const errorDiv = wrapper.querySelector('.password-error');
    const errorText = wrapper.querySelector('.password-error-text');
    
    if (!form || !input || !submitBtn || !errorDiv || !errorText) return;
    
    // 检查是否已经验证过
    const verified = sessionStorage.getItem('post_' + postSlug + '_verified');
    if (verified === 'true') {
      showContent(wrapper);
      return;
    }
    
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const password = input.value.trim();
      
      if (!password) {
        showError('请输入密码');
        return;
      }
      
      // 显示加载状态
      submitBtn.disabled = true;
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<svg class="animate-spin w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> 验证中...';
      
      // 延迟验证
      setTimeout(function() {
        if (password === correctPassword) {
          // 密码正确
          sessionStorage.setItem('post_' + postSlug + '_verified', 'true');
          showSuccess('密码正确，正在加载...');
          setTimeout(function() {
            showContent(wrapper);
          }, 500);
        } else {
          // 密码错误
          showError('密码错误，请重试');
          input.value = '';
          input.focus();
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      }, 300);
    });
    
    function showError(msg) {
      errorDiv.className = 'password-error mt-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-600 dark:text-red-400 text-sm flex items-center gap-2';
      errorText.textContent = msg;
      errorDiv.classList.remove('hidden');
    }
    
    function showSuccess(msg) {
      errorDiv.className = 'password-error mt-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg text-green-600 dark:text-green-400 text-sm flex items-center gap-2';
      errorText.textContent = msg;
      errorDiv.classList.remove('hidden');
    }
    
    function showContent(wrapperEl) {
      // 隐藏密码保护界面
      wrapperEl.style.display = 'none';
      
      // 显示文章内容
      const contentWrapper = document.getElementById('post-content-wrapper');
      if (contentWrapper) {
        contentWrapper.classList.remove('hidden');
        contentWrapper.style.display = 'block';
      }
    }
  }
  
  // 立即执行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPasswordProtect);
  } else {
    initPasswordProtect();
  }
</script>

<style>
  .password-protect-container {
    background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.05) 0%, rgba(var(--primary-rgb), 0.02) 100%);
  }
</style>
