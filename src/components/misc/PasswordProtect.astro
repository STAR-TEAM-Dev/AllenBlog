---
interface Props {
  postSlug: string;
  correctPassword: string;
}

const { postSlug, correctPassword } = Astro.props;
---

<div class="password-protect-wrapper flex flex-col" data-post-slug={postSlug} data-correct-password={correctPassword}>
  <div class="password-protect-container flex-1 flex items-center justify-center p-4 min-h-[calc(100vh-200px)]">
    <div class="password-protect-card bg-[var(--card-bg)] rounded-[var(--radius-large)] shadow-xl p-12 max-w-xl w-full border border-[var(--card-border)] transform transition-all duration-300 hover:shadow-2xl">
      <div class="text-center mb-10">
        <div class="w-24 h-24 bg-[var(--primary)]/10 rounded-full flex items-center justify-center mx-auto mb-8">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-[var(--primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
        </div>
        <h2 class="text-4xl font-bold text-90 mb-4">文章已加密</h2>
        <p class="text-75 text-lg">该文章包含敏感内容，需要密码才能访问</p>
      </div>
      
      <form class="password-form space-y-8">
        <div>
          <label class="block text-base font-medium text-75 mb-3">访问密码</label>
          <div class="relative">
            <input 
              type="password" 
              class="password-input w-full px-5 py-4 text-lg border border-[var(--input-border)] rounded-lg bg-[var(--input-bg)] text-[var(--text-main)] placeholder-[var(--text-muted)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent transition"
              placeholder="请输入密码"
              autocomplete="off"
            />
            <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-[var(--text-muted)]">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </div>
          </div>
        </div>
        <button 
          type="submit" 
          class="password-submit w-full bg-[var(--primary)] hover:bg-[var(--primary)]/90 text-white font-medium py-4 px-6 text-lg rounded-lg transition duration-300 flex items-center justify-center gap-3 shadow-md hover:shadow-lg"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
          </svg>
          验证密码
        </button>
      </form>
      
      <div class="password-error mt-6 p-5 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-600 dark:text-red-400 text-base hidden flex items-center gap-3 animate-fade-in">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span class="password-error-text"></span>
      </div>
    </div>
  </div>
</div>

<script>
  // 等待 DOM 加载完成
  function initPasswordProtect() {
    const wrapper = document.querySelector('.password-protect-wrapper');
    if (!wrapper) return;
    
    const postSlug = wrapper.getAttribute('data-post-slug');
    const correctPassword = wrapper.getAttribute('data-correct-password');
    const form = wrapper.querySelector('.password-form') as HTMLFormElement;
    const input = wrapper.querySelector('.password-input') as HTMLInputElement;
    const submitBtn = wrapper.querySelector('.password-submit') as HTMLButtonElement;
    const errorDiv = wrapper.querySelector('.password-error') as HTMLElement;
    const errorText = wrapper.querySelector('.password-error-text') as HTMLElement;
    
    if (!form || !input || !submitBtn || !errorDiv || !errorText) return;
    
    // 检查是否已经验证过
    const verified = sessionStorage.getItem('post_' + postSlug + '_verified');
    if (verified === 'true') {
      showContent(wrapper);
      return;
    }
    
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const password = input.value.trim();
      
      if (!password) {
        showError('请输入密码');
        return;
      }
      
      // 显示加载状态
      submitBtn.disabled = true;
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<svg class="animate-spin w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> 验证中...';
      
      // 延迟验证
      setTimeout(function() {
        if (password === correctPassword) {
          // 密码正确
          sessionStorage.setItem('post_' + postSlug + '_verified', 'true');
          showSuccess('密码正确，正在加载...');
          setTimeout(function() {
            showContent(wrapper);
          }, 500);
        } else {
          // 密码错误
          showError('密码错误，请重试');
          input.value = '';
          input.focus();
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      }, 300);
    });
    
    function showError(msg) {
      errorDiv.className = 'password-error mt-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-600 dark:text-red-400 text-sm flex items-center gap-2';
      errorText.textContent = msg;
      errorDiv.classList.remove('hidden');
    }
    
    function showSuccess(msg) {
      errorDiv.className = 'password-error mt-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg text-green-600 dark:text-green-400 text-sm flex items-center gap-2';
      errorText.textContent = msg;
      errorDiv.classList.remove('hidden');
    }
    
    function showContent(wrapperEl) {
      // 隐藏密码保护界面
      wrapperEl.style.display = 'none';
      
      // 显示文章内容
      const contentWrapper = document.getElementById('post-content-wrapper');
      if (contentWrapper) {
        contentWrapper.classList.remove('hidden');
        contentWrapper.style.display = 'block';
      }
    }
  }
  
  // 立即执行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPasswordProtect);
  } else {
    initPasswordProtect();
  }
</script>

<style>
  .password-protect-container {
    background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.08) 0%, rgba(var(--primary-rgb), 0.03) 100%);
  }
  
  .password-protect-card {
    animation: slideIn 0.5s ease-out forwards;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-fade-in {
    animation: fadeIn 0.3s ease-in forwards;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .password-input {
    transition: all 0.3s ease;
  }
  
  .password-input:focus {
    box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
  }
  
  .password-submit {
    transition: all 0.3s ease;
  }
  
  .password-submit:hover {
    transform: translateY(-1px);
  }
  
  .password-submit:active {
    transform: translateY(0);
  }
</style>
