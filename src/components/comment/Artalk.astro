---
interface Props {
	path: string;
}

import { commentConfig } from "@/config";

const config = {
	el: "#artalk",
	pageKey: Astro.props.path,
	pageTitle: "",
	server: commentConfig.artalk?.server,
	site: commentConfig.artalk?.site,
	darkMode: commentConfig.artalk?.darkMode,
};
---


<div id="artalk"></div>
<script define:vars={{ config }}>
  function getCurrentTheme() {
    return document.documentElement.classList.contains('dark');
  }
  
  function updateArtalkTheme(isDark) {
    const artalkEl = document.querySelector('#artalk');
    if (artalkEl) {
      if (isDark) {
        artalkEl.setAttribute('data-theme', 'dark');
        artalkEl.classList.add('atk-dark');
        artalkEl.classList.remove('atk-light');
      } else {
        artalkEl.setAttribute('data-theme', 'light');
        artalkEl.classList.add('atk-light');
        artalkEl.classList.remove('atk-dark');
      }
    }
  }
  
  let artalkLoaded = false;
  let artalkObserver = null;
  
  function loadArtalk() {
    if (artalkLoaded) return;
    artalkLoaded = true;
    
    console.log('loadArtalk function called');
    
    const cssLink = document.createElement('link');
    cssLink.rel = 'stylesheet';
    cssLink.href = 'https://artalk.fis.ink/dist/Artalk.css';
    document.head.appendChild(cssLink);
    
    const script = document.createElement('script');
    script.src = 'https://artalk.fis.ink/dist/Artalk.js';
    script.async = true;
    script.onload = () => {
      console.log('Artalk script loaded, initializing...');
      
      try {
        const isDark = getCurrentTheme();
        const artalkInstance = Artalk.init({
          el: config.el,
          pageKey: config.pageKey,
          pageTitle: config.pageTitle || document.title,
          server: config.server,
          site: config.site,
          darkMode: isDark,
        });
        console.log('Artalk initialized successfully with theme:', isDark ? 'dark' : 'light');
        
        window.artalkInstance = artalkInstance;
        
        setTimeout(() => {
          updateArtalkTheme(isDark);
        }, 100);
        
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
              const newIsDark = getCurrentTheme();
              
              updateArtalkTheme(newIsDark);
              
              if (window.artalkInstance) {
                try {
                  if (typeof window.artalkInstance.setDarkMode === 'function') {
                    window.artalkInstance.setDarkMode(newIsDark);
                  } else if (typeof window.artalkInstance.update === 'function') {
                    window.artalkInstance.update({
                      darkMode: newIsDark
                    });
                  } else {
                    const artalkEl = document.querySelector('#artalk');
                    if (artalkEl) {
                      artalkEl.innerHTML = '';
                      const newInstance = window.Artalk.init({
                        el: config.el,
                        pageKey: config.pageKey,
                        pageTitle: config.pageTitle || document.title,
                        server: config.server,
                        site: config.site,
                        darkMode: newIsDark,
                      });
                      window.artalkInstance = newInstance;
                      setTimeout(() => updateArtalkTheme(newIsDark), 100);
                    }
                  }
                  console.log('Artalk theme updated to:', newIsDark ? 'dark' : 'light');
                } catch (error) {
                  console.error('Failed to update Artalk theme:', error);
                  const artalkEl = document.querySelector('#artalk');
                  if (artalkEl) {
                    artalkEl.innerHTML = '';
                    const newInstance = window.Artalk.init({
                      el: config.el,
                      pageKey: config.pageKey,
                      pageTitle: config.pageTitle || document.title,
                      server: config.server,
                      site: config.site,
                      darkMode: newIsDark,
                    });
                    window.artalkInstance = newInstance;
                    setTimeout(() => updateArtalkTheme(newIsDark), 100);
                  }
                }
              }
            }
          });
        });
        
        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['class']
        });
        
      } catch (error) {
        console.error('Artalk initialization failed:', error);
      }
    };
    
    script.onerror = (error) => {
      console.error('Artalk script loading failed:', error);
    };
    
    document.body.appendChild(script);
  }
  
  function setupLazyLoad() {
    const artalkEl = document.querySelector('#artalk');
    if (!artalkEl) return;
    
    if ('IntersectionObserver' in window) {
      artalkObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !artalkLoaded) {
            loadArtalk();
            artalkObserver.unobserve(entry.target);
          }
        });
      }, {
        rootMargin: '200px',
        threshold: 0.01
      });
      
      artalkObserver.observe(artalkEl);
    } else {
      loadArtalk();
    }
  }
  
  document.addEventListener("loadComment", () => {
    loadArtalk();
  }, { once: true });
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupLazyLoad);
  } else {
    setupLazyLoad();
  }
  
  console.log('Artalk component initialized');
</script>